<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futures Trading Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            background-image: radial-gradient(at 0% 0%, #1a1a1a 0%, #0d0d0d 70%);
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }
        .glass-container {
            position: relative;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.125);
            border-radius: 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 2.5rem;
            max-width: 800px;
            width: 100%;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.125);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        .drag-over {
            border-color: rgba(255, 255, 255, 0.5) !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>

    <div class="glass-container text-center">
        <button id="settingsBtn" class="absolute top-4 right-4 p-2 rounded-full bg-gray-800/20 text-gray-400 hover:text-white transition-colors duration-200">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.941 3.31 1.34 1.841 2.723a1.724 1.724 0 00.04 2.503c1.583 1.483-.178 3.514-1.841 2.723a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.941-3.31-1.34-1.841-2.723a1.724 1.724 0 00-.04-2.503c-1.583-1.483.178-3.514 1.841-2.723a1.724 1.724 0 002.573-1.066z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
        </button>

        <h1 class="text-3xl sm:text-4xl font-semibold mb-4 text-white">Futures Chart Analysis</h1>
        <p class="text-sm sm:text-base text-gray-400 mb-8">Upload up to 4 chart screenshots from different timeframes to get a comprehensive analysis.</p>
        
        <!-- Funded Account Challenge Details -->
        <div class="bg-gray-800/20 p-6 rounded-xl border border-gray-600/50 mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-white">Funded Account Challenge Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                <div>
                    <label for="startingBalance" class="block text-gray-400 text-sm font-medium mb-1">Starting Account Balance ($)</label>
                    <input type="number" id="startingBalance" class="w-full bg-gray-900/40 border border-gray-600/50 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors duration-200" placeholder="e.g., 50000">
                </div>
                <div>
                    <label for="profitTarget" class="block text-gray-400 text-sm font-medium mb-1">Profit Target (%)</label>
                    <input type="number" id="profitTarget" class="w-full bg-gray-900/40 border border-gray-600/50 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors duration-200" placeholder="e.g., 8">
                </div>
                <div>
                    <label for="dailyLossCap" class="block text-gray-400 text-sm font-medium mb-1">Daily Loss Cap (%)</label>
                    <input type="number" id="dailyLossCap" class="w-full bg-gray-900/40 border border-gray-600/50 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors duration-200" placeholder="e.g., 5">
                </div>
                <div>
                    <label for="overallLossLimit" class="block text-gray-400 text-sm font-medium mb-1">Overall Loss Limit (%)</label>
                    <input type="number" id="overallLossLimit" class="w-full bg-gray-900/40 border border-gray-600/50 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors duration-200" placeholder="e.g., 10">
                </div>
                <div class="md:col-span-2">
                    <label for="maxRisk" class="block text-gray-400 text-sm font-medium mb-1">Max Risk per Trade (%)</label>
                    <input type="number" id="maxRisk" class="w-full bg-gray-900/40 border border-gray-600/50 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors duration-200" placeholder="e.g., 1">
                </div>
            </div>
        </div>

        <div id="dropzone" class="bg-gray-800/20 p-6 rounded-xl border border-gray-600/50 mb-6 transition-all duration-300 hover:border-white/50 cursor-pointer">
            <input type="file" id="chartInput" accept="image/*" multiple class="hidden">
            <label for="chartInput" class="w-full h-full block">
                <div id="fileInfo" class="flex flex-col items-center justify-center p-8">
                    <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <p class="mt-2 text-gray-400 font-medium">Click or drag charts here</p>
                    <p class="text-xs text-gray-500 mt-1">PNG or JPG files up to 5MB each</p>
                </div>
                <div id="imagePreviewContainer" class="mt-4 hidden grid grid-cols-2 gap-4"></div>
            </label>
        </div>

        <button id="analyzeBtn" class="bg-white text-black font-semibold py-3 px-6 rounded-xl w-full transition-all duration-200 hover:bg-gray-200 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50 active:scale-95">
            Analyze Charts
        </button>

        <div id="loading" class="mt-8 hidden">
            <div class="w-full bg-gray-700 rounded-full h-2.5 mb-4 overflow-hidden">
                <div id="loadingBar" class="bg-white h-2.5 rounded-full transition-all duration-300 ease-in-out" style="width: 0%"></div>
            </div>
            <p class="text-sm text-gray-400">Analyzing charts, please wait...</p>
        </div>

        <div id="result" class="mt-8 text-left space-y-6 hidden">
            <!-- Strategy & Timeframe Box -->
            <div id="summaryBox" class="bg-gray-800/20 p-6 rounded-xl border border-gray-600/50">
                <h2 class="text-xl sm:text-2xl font-semibold mb-2 text-white">Recommended Setup</h2>
                <div id="summaryContent" class="text-gray-300 leading-relaxed"></div>
            </div>

            <!-- Prices Box -->
            <div id="pricesBox" class="bg-gray-800/20 p-6 rounded-xl border border-gray-600/50">
                <h2 class="text-xl sm:text-2xl font-semibold mb-2 text-white">Suggested Prices</h2>
                <div id="pricesContent" class="text-gray-300 leading-relaxed grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
            </div>

            <!-- Rationale Box -->
            <div id="rationaleBox" class="bg-gray-800/20 p-6 rounded-xl border border-gray-600/50">
                <h2 class="text-xl sm:text-2xl font-semibold mb-2 text-white">Technical Rationale</h2>
                <div id="rationaleContent" class="text-gray-300 leading-relaxed"></div>
            </div>
        </div>

        <div id="error" class="mt-8 text-left bg-red-900/30 text-red-300 p-6 rounded-xl border border-red-700/50 hidden">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4">Error</h2>
            <p id="errorContent"></p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content text-left">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-white">Settings</h2>
            <p class="text-gray-400 text-sm mb-6">Enter your Gemini API key to use your own quota for analysis.</p>
            <div class="mb-4">
                <label for="apiKeyInput" class="block text-gray-300 font-medium mb-2">Gemini API Key</label>
                <input type="password" id="apiKeyInput" class="w-full bg-gray-900/40 border border-gray-600/50 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors duration-200">
            </div>
            <button id="saveApiKeyBtn" class="bg-white text-black font-semibold py-2 px-4 rounded-xl w-full transition-all duration-200 hover:bg-gray-200">
                Save API Key
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const chartInput = document.getElementById('chartInput');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loadingDiv = document.getElementById('loading');
            const loadingBar = document.getElementById('loadingBar');
            const resultDiv = document.getElementById('result');
            const summaryContent = document.getElementById('summaryContent');
            const pricesContent = document.getElementById('pricesContent');
            const rationaleContent = document.getElementById('rationaleContent');
            const errorDiv = document.getElementById('error');
            const errorContent = document.getElementById('errorContent');
            const fileInfoDiv = document.getElementById('fileInfo');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const dropzone = document.getElementById('dropzone');
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');

            // Funded account detail inputs
            const startingBalanceInput = document.getElementById('startingBalance');
            const profitTargetInput = document.getElementById('profitTarget');
            const dailyLossCapInput = document.getElementById('dailyLossCap');
            const overallLossLimitInput = document.getElementById('overallLossLimit');
            const maxRiskInput = document.getElementById('maxRisk');

            let imageFileObjects = []; // Changed to store the file objects directly
            let userApiKey = localStorage.getItem('geminiApiKey'); // Retrieve key from localStorage

            const geminiApiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';

            // Load saved challenge details from localStorage
            const savedChallengeDetails = JSON.parse(localStorage.getItem('challengeDetails')) || {};
            startingBalanceInput.value = savedChallengeDetails.startingBalance || '';
            profitTargetInput.value = savedChallengeDetails.profitTarget || '';
            dailyLossCapInput.value = savedChallengeDetails.dailyLossCap || '';
            overallLossLimitInput.value = savedChallengeDetails.overallLossLimit || '';
            maxRiskInput.value = savedChallengeDetails.maxRisk || '';

            // Save challenge details to localStorage on input change
            [startingBalanceInput, profitTargetInput, dailyLossCapInput, overallLossLimitInput, maxRiskInput].forEach(input => {
                input.addEventListener('input', () => {
                    const details = {
                        startingBalance: input.value,
                        profitTarget: profitTargetInput.value,
                        dailyLossCap: dailyLossCapInput.value,
                        overallLossLimit: overallLossLimitInput.value,
                        maxRisk: maxRiskInput.value,
                    };
                    localStorage.setItem('challengeDetails', JSON.stringify(details));
                });
            });

            // Handle file processing for both click and drop events
            function handleFiles(newFiles) {
                const totalFiles = [...imageFileObjects, ...Array.from(newFiles)];
                imageFileObjects = totalFiles.slice(0, 4);

                // Clear previous previews
                imagePreviewContainer.innerHTML = '';

                if (imageFileObjects.length > 0) {
                    fileInfoDiv.classList.add('hidden');
                    imagePreviewContainer.classList.remove('hidden');
                    
                    imageFileObjects.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imgDiv = document.createElement('div');
                            imgDiv.className = 'w-full h-auto overflow-hidden rounded-lg';
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = file.name;
                            img.className = 'w-full h-full object-cover';
                            imgDiv.appendChild(img);
                            imagePreviewContainer.appendChild(imgDiv);
                        };
                        // This now reads the actual File object, not a custom object
                        reader.readAsDataURL(file);
                    });
                } else {
                    fileInfoDiv.classList.remove('hidden');
                    imagePreviewContainer.classList.add('hidden');
                }
            }

            // Event listener for file input change
            chartInput.addEventListener('change', (event) => {
                handleFiles(event.target.files);
            });

            // Event listeners for drag and drop
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-over');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('drag-over');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
                if (e.dataTransfer.files) {
                    handleFiles(e.dataTransfer.files);
                }
            });

            analyzeBtn.addEventListener('click', async () => {
                if (imageFileObjects.length === 0) {
                    showError("Please upload at least one chart screenshot first.");
                    return;
                }
                
                if (!userApiKey) {
                    showError("Please enter and save your Gemini API key in the settings first.");
                    return;
                }

                showLoading();

                // Get the user-entered financial values
                const startingBalance = parseFloat(startingBalanceInput.value) || 0;
                const profitTarget = parseFloat(profitTargetInput.value) || 0;
                const dailyLossCap = parseFloat(dailyLossCapInput.value) || 0;
                const overallLossLimit = parseFloat(overallLossLimitInput.value) || 0;
                const maxRisk = parseFloat(maxRiskInput.value) || 0;

                // Asynchronously read all files before sending the request
                const imageParts = await Promise.all(
                    imageFileObjects.map(file => {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve({
                                inlineData: {
                                    mimeType: file.type,
                                    data: reader.result.split(',')[1]
                                }
                            });
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                    })
                );
                
                // Construct the dynamic prompt with financial constraints
                const prompt = `You are an intraday futures trading assistant. You analyze charts and market data strictly using one of three predefined strategies:
STRATEGY 1: Opening Range Breakout (ORB)
- Define the first 15-minute range of the session.
- Entry: Break above/below that range.
- Stop Loss (SL): Opposite side of the range.
- Take Profit (TP): 1.5–2× stop distance.
STRATEGY 2: VWAP Pullback Reversal
- Identify trend direction relative to VWAP.
- Entry: Enter on pullback to VWAP in trend direction.
- SL: Few ticks beyond VWAP.
- TP: 2× stop distance or last swing high/low.
STRATEGY 3: Support/Resistance Break & Retest
- Identify key support/resistance levels (overnight high/low, yesterday’s high/low, pivots).
- Entry: After breakout and successful retest of the level.
- SL: Just beyond the retested level.
- TP: Next key level or 2× stop distance.
INSTRUCTIONS:
- You will be given up to four chart screenshots, each representing a different timeframe.
- Identify the timeframe for each chart (e.g., 5-minute, 15-minute, 1-hour, 4-hour).
- Evaluate all three strategies across all provided timeframes to determine the most optimal single trade setup. Consider multi-timeframe analysis for confluence.
- IMPORTANT: The analysis must align with the following financial constraints for a funded account challenge:
  - Starting Account Balance: ${startingBalance}
  - Profit Target: ${profitTarget}%
  - Daily Loss Cap: ${dailyLossCap}%
  - Overall Loss Limit: ${overallLossLimit}%
  - Max Risk per Trade: ${maxRisk}% of starting balance.
- Return your analysis in a JSON format. Your response MUST be a JSON object with the keys 'strategy_used' (string), 'timeframe' (string), 'entry_price' (number), 'stop_loss' (number), 'take_profit' (number), and 'reasoning' (string). The prices must be numbers, not strings, and be provided with full decimal precision.
RULES:
- Do not invent new strategies.
- Always provide entry, stop loss, and take profit.
- Provide all prices with full decimal precision.
- Keep reasoning concise (1–3 sentences).
- If no clear strategy is valid across all provided charts, respond with:
{ "strategy_used": "None", "timeframe": "N/A", "entry_price": 0, "stop_loss": 0, "take_profit": 0, "reasoning": "No valid setup at this time. Wait for clearer conditions." }`;

                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: prompt },
                                ...imageParts
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "strategy_used": { "type": "STRING" },
                                "timeframe": { "type": "STRING" },
                                "entry_price": { "type": "NUMBER" },
                                "stop_loss": { "type": "NUMBER" },
                                "take_profit": { "type": "NUMBER" },
                                "reasoning": { "type": "STRING" }
                            },
                            "required": ["strategy_used", "timeframe", "entry_price", "stop_loss", "take_profit", "reasoning"]
                        }
                    }
                };
                
                let attempt = 0;
                const maxAttempts = 3;
                while (attempt < maxAttempts) {
                    try {
                        const response = await fetch(geminiApiUrl + userApiKey, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (!response.ok || !result.candidates || result.candidates.length === 0) {
                            throw new Error('API response failed or was empty.');
                        }
                        
                        const jsonText = result.candidates[0]?.content?.parts[0]?.text;
                        if (jsonText) {
                            hideLoading();
                            displayResult(JSON.parse(jsonText));
                            return;
                        } else {
                            throw new Error('No JSON content in the API response.');
                        }
                    } catch (e) {
                        console.error(`Attempt ${attempt + 1} failed:`, e);
                        attempt++;
                        if (attempt < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                        } else {
                            hideLoading();
                            showError("Failed to analyze the charts. Please try again later. Check your API key in settings.");
                        }
                    }
                }
            });

            // Settings modal functionality
            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
                if (userApiKey) {
                    apiKeyInput.value = userApiKey;
                }
            });
            closeModalBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });
            saveApiKeyBtn.addEventListener('click', () => {
                const apiKey = apiKeyInput.value.trim();
                if (apiKey) {
                    userApiKey = apiKey;
                    localStorage.setItem('geminiApiKey', apiKey);
                    console.log("API key saved successfully to localStorage.");
                }
                settingsModal.classList.add('hidden');
            });

            function showLoading() {
                loadingDiv.classList.remove('hidden');
                resultDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');
                // Simulate loading bar progress
                let width = 0;
                const interval = setInterval(() => {
                    width += 5;
                    if (width <= 95) {
                        loadingBar.style.width = `${width}%`;
                    } else {
                        clearInterval(interval);
                    }
                }, 100);
            }

            function hideLoading() {
                loadingDiv.classList.add('hidden');
                loadingBar.style.width = '0%';
            }

            function displayResult(result) {
                if (result.strategy_used === "None") {
                    document.getElementById('summaryBox').classList.add('hidden');
                    document.getElementById('pricesBox').classList.add('hidden');
                    document.getElementById('rationaleBox').classList.remove('hidden');
                    rationaleContent.innerHTML = result.reasoning;
                } else {
                    document.getElementById('summaryBox').classList.remove('hidden');
                    document.getElementById('pricesBox').classList.remove('hidden');
                    document.getElementById('rationaleBox').classList.remove('hidden');
                    
                    summaryContent.innerHTML = `
                        <p class="text-xl sm:text-2xl font-semibold mb-2 text-white">${result.strategy_used}</p>
                        <p class="text-base text-gray-400">Timeframe: <span class="text-white">${result.timeframe}</span></p>
                    `;
                    rationaleContent.innerHTML = result.reasoning;
                    
                    pricesContent.innerHTML = `
                        <div class="bg-gray-900/40 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-400 font-semibold mb-1">Entry Price</p>
                            <p class="text-lg font-bold text-white">${result.entry_price}</p>
                        </div>
                        <div class="bg-gray-900/40 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-400 font-semibold mb-1">Take Profit (TP)</p>
                            <p class="text-lg font-bold text-white">${result.take_profit}</p>
                        </div>
                        <div class="bg-gray-900/40 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-400 font-semibold mb-1">Stop Loss (SL)</p>
                            <p class="text-lg font-bold text-white">${result.stop_loss}</p>
                        </div>
                    `;
                }
                
                resultDiv.classList.remove('hidden');
            }

            function showError(message) {
                errorContent.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
